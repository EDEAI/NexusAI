"use strict";(self.webpackChunkant_design_pro=self.webpackChunkant_design_pro||[]).push([[142,735],{36711:function(ft,De,t){t.r(De),t.d(De,{waitTime:function(){return d},waitTimePromise:function(){return _e}});var Ke=t(97857),w=t.n(Ke),Re=t(5574),Ge=t.n(Re),ze=t(15009),ge=t.n(ze),Je=t(99289),Te=t.n(Je),Ye=t(42237),Ce=t(29608),Pe=t(36951),V=t(35312),ye=t(67294),Xe=t(85893),_e=function(){var Z=Te()(ge()().mark(function s(){var e,te=arguments;return ge()().wrap(function(z){for(;;)switch(z.prev=z.next){case 0:return e=te.length>0&&te[0]!==void 0?te[0]:100,z.abrupt("return",new Promise(function(X){setTimeout(function(){X(!0)},e)}));case 2:case"end":return z.stop()}},s)}));return function(){return Z.apply(this,arguments)}}(),d=function(){var Z=Te()(ge()().mark(function s(){var e,te=arguments;return ge()().wrap(function(z){for(;;)switch(z.prev=z.next){case 0:return e=te.length>0&&te[0]!==void 0?te[0]:100,z.next=3,_e(e);case 3:case"end":return z.stop()}},s)}));return function(){return Z.apply(this,arguments)}}();De.default=function(){var Z=(0,V.useIntl)(),s=[{dataIndex:"index",valueType:"indexBorder",width:48},{title:Z.formatMessage({id:"workflow.toName",defaultMessage:""}),dataIndex:"app_runs_name",ellipsis:!0,fieldProps:{onChange:function(xe){var W;he==null||(W=he.current)===null||W===void 0||W.submit()}}},{title:Z.formatMessage({id:"workflow.created_time",defaultMessage:""}),dataIndex:"created_time",ellipsis:!0,tooltip:Z.formatMessage({id:"workflow.created_time_des",defaultMessage:Z.formatMessage({id:"workflow.created_time_des",defaultMessage:""})}),search:!1},{disable:!0,title:Z.formatMessage({id:"workflow.status",defaultMessage:""}),dataIndex:"app_runs_status",filters:!0,onFilter:!0,ellipsis:!0,valueType:"select",fieldProps:{onChange:function(xe){var W;he==null||(W=he.current)===null||W===void 0||W.submit()}},valueEnum:{1:{text:Z.formatMessage({id:"workflow.running",defaultMessage:""}),status:"Processing"},2:{text:Z.formatMessage({id:"workflow.runSc",defaultMessage:""}),status:"Success"},3:{text:Z.formatMessage({id:"workflow.runF",defaultMessage:""}),status:"Error"}}},{title:"".concat(Z.formatMessage({id:"workflow.elapsed_time",defaultMessage:""}),"S"),dataIndex:"elapsed_time",ellipsis:!0,tooltip:Z.formatMessage({id:"workflow.run_time"}),search:!1},{title:"Tokens",key:"showTime",dataIndex:"total_tokens",hideInSearch:!0},{title:Z.formatMessage({id:"workflow.user"}),dataIndex:"nickname",search:!1,key:"user"}],e=(0,V.useSearchParams)(),te=Ge()(e,1),Ee=te[0],z=(0,Ce.Z)(function(I){return I.setRunPanelLogRecord}),X=Ee.get("app_id"),he=(0,ye.useRef)(null);return(0,Xe.jsx)(Pe.Z,{columns:s,formRef:he,form:{submitter:!1},cardBordered:!0,request:function(){var I=Te()(ge()().mark(function xe(W,Be,O){var Q;return ge()().wrap(function(Me){for(;;)switch(Me.prev=Me.next){case 0:return console.log(W,Be,O),Me.next=3,(0,Ye.bB)(w()(w()({app_runs_name:"",app_runs_status:0},W),{},{app_id:X}));case 3:return Q=Me.sent,console.log(Q),Me.abrupt("return",{data:Q.data.list,success:!0,total:Q.data.total_count});case 6:case"end":return Me.stop()}},xe)}));return function(xe,W,Be){return I.apply(this,arguments)}}(),onRow:function(xe){return{onClick:function(){console.log("Row clicked:",xe),z(xe)}}},editable:{type:"multiple"},rowKey:"app_runs_id",search:{labelWidth:"auto"},options:{setting:{listsHeight:600}},pagination:{pageSize:12,showSizeChanger:!1},dateFormatter:"string",headerTitle:Z.formatMessage({id:"workflow.workflowLog",defaultMessage:""})})}},1302:function(ft,De,t){t.r(De),t.d(De,{default:function(){return Ut}});var Ke=t(5574),w=t.n(Ke),Re=t(47520),Ge=t(36711),ze=t(82826),ge=t(43425),Je=t(48869),Te=t(69243),Ye=t(91806),Ce=t(34994),Pe=t(52688),V=t(35312),ye=t(77598),Xe=t(55241),_e=t(50136),d=t(67294),Z=t(10899),s=t(1096),e=t(85893),te=function(){var f,i=(0,V.useIntl)(),S=(0,d.useState)(!0),U=w()(S,2),g=U[0],E=U[1],D=(0,s.Z)(function(v){return v.setWorkflowEditInfo}),l=(0,s.Z)(function(v){return v.workFlowInfo}),N=(0,s.Z)(function(v){return v.setSelect}),q=(0,d.useState)("1"),J=w()(q,2),de=J[0],ce=J[1],n=(0,d.useState)(!1),ne=w()(n,2),ee=ne[0],fe=ne[1],p=(0,Z.Z)(),k=(0,d.useRef)(null),o=function(){var x,j;return(0,e.jsx)("div",{className:"",children:(0,e.jsx)("div",{className:"w-[240px]  ",children:(0,e.jsxs)(Ce.A,{formRef:k,submitter:{render:function(){return null}},onValuesChange:P,layout:"horizontal",children:[(0,e.jsx)(Pe.Z,{name:"is_public",label:i.formatMessage({id:"component.label.teamVisible",defaultMessage:""})}),(0,e.jsx)(Pe.Z,{tooltip:(l==null||(x=l.app)===null||x===void 0?void 0:x.publish_status)!="1"?{title:i.formatMessage({id:"component.tooltip.publishWorkflowFirst",defaultMessage:""})}:null,formItemProps:{className:"mb-0"},disabled:(l==null||(j=l.app)===null||j===void 0?void 0:j.publish_status)!="1",name:"enable_api",label:"API"})]})})})},h=[{key:"4",icon:(0,e.jsx)(ze.Z,{}),label:i.formatMessage({id:"component.menu.backToPreviousPage",defaultMessage:""})},{key:"0",icon:l!=null&&l.isProd?(0,e.jsx)(ge.Z,{}):(0,e.jsx)(Xe.Z,{content:o,trigger:"click",forceRender:!0,placement:"rightTop",title:i.formatMessage({id:"component.menu.setting",defaultMessage:""}),children:(0,e.jsx)(ge.Z,{})}),label:i.formatMessage({id:"component.menu.setting",defaultMessage:""}),disabled:l==null?void 0:l.isProd},{key:"1",icon:(0,e.jsx)(Je.Z,{}),label:i.formatMessage({id:"component.menu.arrange",defaultMessage:""})},{key:"2",icon:(0,e.jsx)(Te.Z,{}),label:i.formatMessage({id:"component.menu.accessAPI",defaultMessage:"API"}),title:ee?i.formatMessage({id:"component.menu.accessAPI",defaultMessage:"API"}):i.formatMessage({id:"component.tooltip.enableAPIFirst",defaultMessage:"API"}),disabled:!ee},{key:"3",icon:(0,e.jsx)(Ye.Z,{}),label:i.formatMessage({id:"component.menu.log",defaultMessage:""})}];(0,ye.Z)(function(){if(l){var v,x,j,R,_=l==null||(v=l.app)===null||v===void 0?void 0:v.is_public,We=l==null||(x=l.app)===null||x===void 0?void 0:x.enable_api,ve={};ve.is_public=!!_,ve.enable_api=(l==null||(j=l.app)===null||j===void 0?void 0:j.publish_status)=="1"?!!We:!1,console.log(ve),fe(ve.enable_api),k==null||(R=k.current)===null||R===void 0||R.setFieldsValue(ve)}},[l]);var P=function(x,j){console.log(x,j),m(j.enable_api),D(j),setTimeout(p,300)},m=function(x){fe(!!x)},ae=function(x){var j;switch(x.key){case"4":V.history.go(-1);break;case"0":break;case"2":window.open(Re._n+(l==null||(j=l.app)===null||j===void 0?void 0:j.api_url),"_blank");break;default:N(""),ce(x.key)}};return(0,e.jsxs)(e.Fragment,{children:[(0,e.jsxs)("div",{className:"fixed left-0 top-16 mt-2 transition-all duration-300 z-20",children:[(0,e.jsx)(_e.Z,{defaultSelectedKeys:["1"],selectedKeys:[de],className:"w-10 rounded-md",mode:"vertical",inlineCollapsed:g,items:h,onClick:ae}),de=="0"&&(0,e.jsx)("div",{className:"absolute top-0 left-full ml-2",children:(0,e.jsx)("div",{className:"w-[240px]  bg-white  rounded-md p-4 border border-gray-200",children:(0,e.jsxs)(Ce.A,{formRef:k,submitter:{render:function(){return null}},onValuesChange:P,layout:"horizontal",children:[(0,e.jsx)(Pe.Z,{name:"is_public",label:i.formatMessage({id:"component.label.teamVisible",defaultMessage:""})}),(0,e.jsx)(Pe.Z,{disabled:!(l!=null&&(f=l.app)!==null&&f!==void 0&&f.api_url),name:"enable_api",label:"API"})]})})})]}),de=="3"&&(0,e.jsx)("div",{className:"fixed right-0 top-[56px]   pl-12 pt-4 pr-2 bg-white z-10",style:{height:"calc(100vh - 56px)"},children:(0,e.jsx)("div",{className:"bg-white rounded-md h-full",children:(0,e.jsx)(Ge.default,{})})})]})},Ee=te,z=t(15009),X=t.n(z),he=t(97857),I=t.n(he),xe=t(99289),W=t.n(xe),Be=t(32060),O=t(42237),Q=t(63648),vt=t(16091),Me=t(13118),rt=t(78234),Oe=t(2453),mt=t(17788),ie=t(71471),pt=t(64599),gt=t.n(pt),Qe=t(7493),ht=t(34559),ue=t(96906),$t=function(f){return{nodes:f.nodes,edges:f.edges,onNodesChange:f.onNodesChange,onEdgesChange:f.onEdgesChange,onConnect:f.onConnect,nodeTypes:f.nodeTypes,connectionLineStyle:f.connectionLineStyle,defaultViewport:f.defaultViewport,onDrop:f.onDrop,onDragOver:f.onDragOver,setSelect:f.setSelect,preventScrolling:f.preventScrolling}},xt=(0,d.memo)(function(T){var f=T.children,i=(0,V.useIntl)(),S=(0,s.Z)(function(o){return o.nodes}),U=(0,s.Z)(function(o){return o.getEdges}),g=(0,s.Z)(function(o){return o.edges}),E=(0,s.Z)(function(o){return o.setEdges}),D=(0,s.Z)(function(o){return o.onNodesChange}),l=(0,s.Z)(function(o){return o.onEdgesChange}),N=(0,s.Z)(function(o){return o.onConnect}),q=(0,s.Z)(function(o){return o.nodeTypes}),J=(0,s.Z)(function(o){return o.connectionLineStyle}),de=(0,s.Z)(function(o){return o.defaultViewport}),ce=(0,s.Z)(function(o){return o.onDrop}),n=(0,s.Z)(function(o){return o.onDragOver}),ne=(0,s.Z)(function(o){return o.setSelect}),ee=(0,s.Z)(function(o){return o.preventScrolling}),fe=(0,d.useCallback)(function(o){var h=S.find(function(m){return m.id===o.target}),P=function m(ae){var v=arguments.length>1&&arguments[1]!==void 0?arguments[1]:new Set;if(v.has(ae.id))return!1;v.add(ae.id);var x=gt()((0,Qe.xA)(ae,S,g)),j;try{for(x.s();!(j=x.n()).done;){var R=j.value;if(R.id===o.source||m(R,v))return!0}}catch(_){x.e(_)}finally{x.f()}};return h.id===o.source?!1:!P(h)},[S,g]),p=function(){},k=(0,d.useCallback)(function(o,h){console.log(o,h,U(),(0,Qe.Kz)(o,h,g)),E((0,Qe.Kz)(o,h,U()))},[]);return(0,ye.Z)(function(){},[S]),(0,e.jsx)(ht.tV,{children:(0,e.jsx)(Q.x$,{onViewportChange:p,nodes:S,edges:g,onNodesChange:D,onEdgesChange:l,onEdgesDelete:function(h){},onConnect:N,onReconnect:k,nodeTypes:q,minZoom:.3,maxZoom:1,connectionLineStyle:J,snapToGrid:!1,isValidConnection:fe,connectionRadius:30,preventScrolling:ee,onDragOver:n,onPaneClick:function(){ne("")},onPaneContextMenu:function(h){h.preventDefault()},onSelectionChange:function(h){},onNodeClick:function(h,P){ne(P.id)},onEdgeClick:function(h,P){},deleteKeyCode:["Delete","Backspace"],onNodesDelete:function(h){},onBeforeDelete:function(){var o=W()(X()().mark(function h(P){var m;return X()().wrap(function(v){for(;;)switch(v.prev=v.next){case 0:if((P==null||(m=P.nodes)===null||m===void 0||(m=m[0])===null||m===void 0?void 0:m.type)!=ue.vW.Start){v.next=3;break}return Oe.ZP.error(i.formatMessage({id:"workflow.delStartNodeError"})),v.abrupt("return",Promise.reject(i.formatMessage({id:"workflow.delStartNodeError"})));case 3:return ne(""),v.abrupt("return",Promise.resolve(P));case 5:case"end":return v.stop()}},h)}));return function(h){return o.apply(this,arguments)}}(),fitView:!0,children:f})})}),wt=function(f){var i=(0,d.useCallback)(function(g){g.preventDefault(),g.dataTransfer.dropEffect="move"},[]),S=(0,d.useCallback)(function(g){g.preventDefault();var E=g.dataTransfer.getData("application/reactflow");if(!E)return null;var D=JSON.parse(E),l=D.type,N=D.item;if(!l||!N)return null;var q=f({x:g.clientX,y:g.clientY});return{position:q,type:l,item:N}},[f]),U=(0,d.useCallback)(function(g){var E=function(l){var N=S(l);N&&g(N.position,N.type,N.item)};return document.addEventListener("dragover",i),document.addEventListener("drop",E),function(){document.removeEventListener("dragover",i),document.removeEventListener("drop",E)}},[i,S]);return{onDnD:U}},Mt=wt,yt=t(83065),jt=t(39944),qe=t(10759),Ne=t(55927),St=t(33914),Dt=t(88284),Ct=t(28508),st=t(90672),Pt=t(46822),bt=t(97462),Zt=t(64317),It=t(29933),kt=t(3917),Tt=t(40056),lt=t(2487),je=t(28036),Et=t(96486),it=t.n(Et),be=t(29432),He=t(92485),Kt=ie.Z.Text,Gt=Tt.Z.ErrorBoundary,Ot=(0,d.memo)(function(){var T,f,i=(0,V.useIntl)(),S=(0,d.useState)(!1),U=w()(S,2),g=U[0],E=U[1],D=(0,Ne.Z)(function(r){return r.dealtWithData}),l=(0,Ne.Z)(function(r){return r.setDealtWithData}),N=(0,Ne.Z)(function(r){return r.setFlowMessage}),q=(0,Ne.Z)(function(r){return r.getNeedHumanConfirmMessage}),J=(0,Ne.Z)(function(r){return r.flowMessage}),de=(0,d.useState)(null),ce=w()(de,2),n=ce[0],ne=ce[1],ee=(0,d.useState)(""),fe=w()(ee,2),p=fe[0],k=fe[1],o=(0,d.useState)(!1),h=w()(o,2),P=h[0],m=h[1],ae=(0,d.useState)(""),v=w()(ae,2),x=v[0],j=v[1],R=(0,kt.Z)(O.N7,{manual:!0}),_=R.loading,We=R.runAsync;(0,d.useEffect)(function(){var r;E(!!D);var u=D==null||(r=D.data)===null||r===void 0||(r=r.node_exec_data)===null||r===void 0?void 0:r.node_exec_id;return console.log(D,u),k(u),u&&ve(u),function(){E(!1)}},[D]);var ve=function(u){_||We(u).then(function(c){c.data&&(ne(c.data),u!=x&&(m(!1),j(u)))})};(0,ye.Z)(function(){console.log(J,p);var r=J.find(function(u){var c;return(u==null||(c=u.data)===null||c===void 0||(c=c.node_exec_data)===null||c===void 0?void 0:c.node_exec_id)==p});console.log(r),r&&ve(p)},[J.length]);var dt=function(u){m(!0),(0,O.YX)(p,{correct_prompt:new jt.N("",u.prompt,""),operation:1,outputs:(n==null?void 0:n.outputs)||null}).then(function(c){c.code==0&&(Ze(p),k(c.data.exec_id))})},Ze=function(u){var c=J.filter(function(M){var C;return!((M==null||(C=M.data)===null||C===void 0||(C=C.node_exec_data)===null||C===void 0?void 0:C.node_exec_id)==u&&(M==null?void 0:M.type)=="workflow_need_human_confirm")});N(c)},Ve=function(){(0,O.YX)(p,{operation:0,outputs:(n==null?void 0:n.outputs)||null}).then(function(u){u.code==0&&(E(!1),Ze(p),l(null))})},et=(0,d.useCallback)(function(){var r,u,c=D==null||(r=D.data)===null||r===void 0||(r=r.node_exec_data)===null||r===void 0?void 0:r.node_type;return(0,e.jsxs)(e.Fragment,{children:[(0,e.jsxs)("div",{className:"flex flex-col gap-2 mt-4",children:[c!=ue.vW.LLM&&(0,e.jsx)("div",{className:"h-80",children:(0,e.jsx)(He.Z,{language:"python3",value:n==null?void 0:n.inputs,readOnly:!0,isJSONStringifyBeauty:!0,onChange:function(){},title:"input"})}),(n==null||(u=n.correct_llm_history)===null||u===void 0?void 0:u.length)>0&&(0,e.jsx)(lt.Z,{header:(0,e.jsx)(ie.Z.Title,{level:5,children:i.formatMessage({id:"workflow.historyPrompt",defaultMessage:"prompt"})}),dataSource:n==null?void 0:n.correct_llm_history,renderItem:function(C){var A;return(0,e.jsx)(lt.Z.Item,{children:C==null||(A=C.correct_prompt)===null||A===void 0||(A=A.user)===null||A===void 0?void 0:A.value})}}),(0,e.jsx)("div",{className:"h-80",children:(0,e.jsx)(He.Z,{language:"python3",value:n==null?void 0:n.outputs,readOnly:!0,isJSONStringifyBeauty:!0,onChange:function(){},title:"output"})})]}),(0,e.jsx)(Ce.A,{submitter:{resetButtonProps:!1,submitButtonProps:{className:"w-full"},searchConfig:{submitText:i.formatMessage({id:"workflow.xz"})}},loading:P,onFinish:dt,children:(0,e.jsx)("div",{className:"flex ",children:(0,e.jsxs)("div",{className:"flex-1 pt-2 border-stone-300 border rounded-md my-2",children:[(0,e.jsxs)("div",{className:"px-2 flex justify-between cursor-default",children:[(0,e.jsx)("div",{children:(0,e.jsx)("div",{className:"text-sm text-gray-500 font-bold pb-1",children:"Prompt"})}),(0,e.jsx)("div",{})]}),(0,e.jsx)("div",{className:" pb-6 user-input-error",children:(0,e.jsx)(st.Z,{formItemProps:{className:"mb-0"},name:"prompt",required:!0,rules:[{required:!0,message:i.formatMessage({id:"workflow.requireInputPrompt"})}],fieldProps:{variant:"borderless",placeholder:i.formatMessage({id:"workflow.requireInputPrompt"}),autoSize:{minRows:2,maxRows:40},count:{show:function(C){var A=C.value,oe=C.count,$=C.maxLength;return(0,e.jsx)("div",{className:"pr-2 text-blue-400",children:oe})}}}})})]})})})]})},[n]),tt=(0,d.useCallback)(function(){var r,u,c,M=n==null||(r=n.node_graph)===null||r===void 0||(r=r.data)===null||r===void 0?void 0:r.input,C=M==null?void 0:M.properties,A=n==null||(u=n.node_graph)===null||u===void 0||(u=u.data)===null||u===void 0?void 0:u.requires_upload,oe=n==null||(c=n.node_graph)===null||c===void 0||(c=c.data)===null||c===void 0||(c=c.import_to_knowledge_base)===null||c===void 0?void 0:c.input;console.log("requires_upload",n,A);var $=(0,s.Z)(function(F){return F.datasetData});if(!C)return(0,e.jsx)(e.Fragment,{children:i.formatMessage({id:"workflow.requireInputPrompt",defaultMessage:""})});var we=Object.values(C),re=function(K){var b;console.log(K);var G=(0,qe.vV)(M);if(we.length>0){var ke=Object.entries(K).filter(function(Y){var L=w()(Y,2),me=L[0],a=L[1];return me.startsWith("variables.")});ke.forEach(function(Y){var L=w()(Y,2),me=L[0],a=L[1];G.properties[me.replace("variables.","")].value=a})}var B=new qe.V7(be.Mp,"array[number]");K.file&&K.file.forEach(function(Y){var L,me=new qe._w(Y.uid,"number",(Y==null||(L=Y.response)===null||L===void 0||(L=L.data)===null||L===void 0?void 0:L.file_id)||0);B.addValue(me)}),G.addProperty(be.Mp,B),console.log(G,B);var se=(n==null||(b=n.node_graph)===null||b===void 0||(b=b.data)===null||b===void 0?void 0:b.knowledge_base_mapping)||{input:{},output:{}};Object.entries(K).forEach(function(Y){var L=w()(Y,2),me=L[0],a=L[1];me.startsWith("dataset.")&&(se.input[be.Mp]||(se.input[be.Mp]={}),se.input[be.Mp][me.replace("dataset.","")]=a)}),console.log(se),(0,O.YX)(p,{operation:0,inputs:G,outputs:null,correct_prompt:null,knowledge_base_mapping:se}).then(function(Y){Y.code==0&&(E(!1),l(null),Ze(p))})},Fe={icon:(0,e.jsx)(St.Z,{}),title:i.formatMessage({id:"workflow.uploadFileText",defaultMessage:"\uFF0C"}),description:i.formatMessage({id:"workflow.uploadFileDes"}),accept:".txt,.md,.pdf,.html,.xlsx,.xls,.docx,.csv",fieldProps:{listType:"picture",name:"file",multiple:!0,headers:{Authorization:"Bearer ".concat(localStorage.getItem("token"))},action:yt.M$,beforeUpload:function(K){var b=K.size/1024/1024<15;return b||Oe.ZP.error(i.formatMessage({id:"workflow.uploadFileErrorText"})),b}}};return(0,e.jsx)("div",{className:"mt-4",children:(0,e.jsxs)(Ce.A,{submitter:{resetButtonProps:!1,submitButtonProps:{className:"w-full"},searchConfig:{submitText:i.formatMessage({id:"workflow.checked",defaultMessage:""})}},onFinish:re,children:[we.map(function(F){return(0,e.jsx)(st.Z,{label:F.display_name,name:"variables.".concat(F.name),required:F.required,rules:[{required:F.required,message:i.formatMessage({id:"workflow.toInput"})}]},F.name)}),A&&(0,e.jsx)(Pt.Z,I()({name:"file"},Fe)),(0,e.jsx)(bt.Z,{name:["file"],children:function(K){var b=K.file;return oe&&(b==null?void 0:b.length)>0&&(b==null?void 0:b.map(function(G){return(0,e.jsx)(Zt.Z,{label:G.name,name:"dataset.".concat(G.uid),options:($==null?void 0:$.list)||[],required:!0,rules:[{required:!0,message:i.formatMessage({id:"workflow.select_to_knowledge_base"})}]},G.uid)}))||null}})]})})},[n]),Ie=function(u){if(u.type!=="object"||!u.properties)return[u];var c=[],M=function C(A){var oe=arguments.length>1&&arguments[1]!==void 0?arguments[1]:"";it().forOwn(A,function($,we){var re=oe?"".concat(oe,".").concat(we):we;$.type==="object"&&$.properties?C($.properties,re):c.push(I()(I()({},$),{},{name:re}))})};return M(u.properties),c},Ae=function(u){return u.reduce(function(c,M){return c[M.name]=M.value,c},{})},Ue=(0,d.useCallback)(function(){console.log(n);var r=n==null?void 0:n.inputs,u=(0,d.useRef)(null),c=(0,d.useState)([]),M=w()(c,2),C=M[0],A=M[1],oe=(0,d.useState)({}),$=w()(oe,2),we=$[0],re=$[1],Fe=Oe.ZP.useMessage(),F=w()(Fe,2),K=F[0],b=F[1];(0,rt.Z)(function(){n!=null&&n.outputs&&(console.log(r,Ie(n==null?void 0:n.outputs)),A(Ie(n==null?void 0:n.outputs)),re(JSON.stringify(Ie(n==null?void 0:n.outputs))))});var G=function(){var B={};try{B=JSON.parse(we),console.log(B,B[0]),(0,O.YX)(p,{outputs:it().isArray(B)?B[0]:B}).then(function(se){se.code==0&&(K.success(i.formatMessage({id:"workflow.checkSc",defaultMessage:""})),E(!1),Ze(p),l(null))})}catch(se){console.log(se),K.error(i.formatMessage({id:"workflow.checkOutputMessageError",defaultMessage:","}))}};return(0,e.jsxs)("div",{children:[b,(0,e.jsxs)("div",{className:"flex flex-col gap-2 pt-4",children:[!be.eT.includes(n==null?void 0:n.node_type)&&(0,e.jsxs)("div",{children:[(0,e.jsx)(ie.Z.Title,{level:5,children:"Inputs"}),(0,e.jsx)("div",{className:"h-80",children:(0,e.jsx)(He.Z,{language:"python3",value:n==null?void 0:n.inputs,readOnly:!0,isJSONStringifyBeauty:!0,onChange:function(B){re(B)}})})]}),(0,e.jsxs)(ie.Z.Title,{level:5,children:["Outputs(",i.formatMessage({id:"workflow.toEdit",defaultMessage:""}),")"]}),(0,e.jsx)("div",{className:"h-80",children:(0,e.jsx)(He.Z,{language:"python3",value:n==null?void 0:n.outputs,isJSONStringifyBeauty:!0,onChange:function(B){re(B)}})}),(0,e.jsx)(je.ZP,{type:"primary",onClick:G,className:"w-full mt-4",children:i.formatMessage({id:"workflow.checked",defaultMessage:""})})]})]})},[n]),$e=(0,d.useCallback)(function(){var r=n==null?void 0:n.node_type;return r==ue.vW.Human?(0,e.jsx)(tt,{}):r==ue.vW.LLM||r==ue.vW.Agent||r==ue.vW.TaskGeneration?(0,e.jsx)(et,{}):(0,e.jsx)(Ue,{})},[n]),nt=function(){var u=n==null?void 0:n.node_type;return u==ue.vW.LLM||u==ue.vW.Agent||u==ue.vW.TaskGeneration?(0,e.jsx)(je.ZP,{type:"text",onClick:Ve,className:"text-green-500",disabled:P,icon:(0,e.jsx)(Dt.Z,{}),children:i.formatMessage({id:"workflow.checkBackLogs",defaultMessage:""})}):null};return g?(0,e.jsx)(It.Z,{className:"w-[400px] border border-blue-300 fixed z-10  top-[105px] right-2 ",style:{height:"calc(100vh - 10px - 100px)"},extra:(0,e.jsxs)("div",{className:"flex gap-2",children:[(0,e.jsx)(nt,{}),(0,e.jsx)(je.ZP,{onClick:function(){E(!1),l(null)},type:"text",icon:(0,e.jsx)(Ct.Z,{})})]}),title:(0,e.jsx)(ie.Z.Title,{level:5,children:i.formatMessage({id:"workflow.backlogs",defaultMessage:""})}),bodyStyle:{overflowY:"auto",marginTop:"20px",boxSizing:"border-box"},children:(0,e.jsxs)("div",{children:[(0,e.jsx)("div",{children:(0,e.jsx)(ie.Z.Title,{level:5,children:n==null||(T=n.node_graph)===null||T===void 0||(T=T.data)===null||T===void 0?void 0:T.title})}),(0,e.jsx)("div",{children:(0,e.jsx)(ie.Z.Text,{children:n==null||(f=n.node_graph)===null||f===void 0||(f=f.data)===null||f===void 0?void 0:f.desc})}),$e()]})}):null}),ut=t(55877),Nt=t(94791),Wt=t(74842),At=t(98165),Ft=t(58638),Lt=t(27484),Rt=t.n(Lt),_t=(0,d.memo)(function(){var T=(0,V.useIntl)(),f=(0,V.useSearchParams)(),i=w()(f,1),S=i[0],U=(0,s.Z)(function(p){return p.setWorkFlowInfo}),g=(0,s.Z)(function(p){return p.workFlowInfo}),E=(0,s.Z)(function(p){return p.setRunPanelShow}),D=S.get("type")=="true",l=(0,Z.Z)(),N=Oe.ZP.useMessage(),q=w()(N,2),J=q[0],de=q[1],ce=function(){var k=S.get("app_id");(0,O.aJ)(k).then(function(o){console.log(o),o.code==0&&(U(I()(I()({},g),{},{app:I()(I()({},g==null?void 0:g.app),{},{publish_status:"1"})})),J.open({type:"success",content:T.formatMessage({id:"workflow.releaseSuc"})}))})},n=function(){E(!0)},ne=function(){var p=W()(X()().mark(function k(){var o,h;return X()().wrap(function(m){for(;;)switch(m.prev=m.next){case 0:return o=S.get("app_id"),m.next=3,(0,O.Uq)(o);case 3:h=m.sent;case 4:case"end":return m.stop()}},k)}));return function(){return p.apply(this,arguments)}}(),ee=function(){var p=W()(X()().mark(function k(){var o,h,P,m;return X()().wrap(function(v){for(;;)switch(v.prev=v.next){case 0:h=S.get("app_id"),P=(g==null||(o=g.app)===null||o===void 0?void 0:o.name)||"workflow",m=Rt()().format("YYYY_MM_DD-HH_mm_ss"),(0,O.w8)(h,D==!0?1:0).then(function(x){var j=new Blob([x],{type:"text/yaml"}),R=URL.createObjectURL(j),_=document.createElement("a");_.href=R,_.download="".concat(P,"_").concat(m,".yml"),document.body.appendChild(_),_.click(),document.body.removeChild(_),URL.revokeObjectURL(R)});case 4:case"end":return v.stop()}},k)}));return function(){return p.apply(this,arguments)}}(),fe={name:"file",fileList:null,action:Re._n+"/v1/workflow/import",accept:".yml",multiple:!1,headers:{Authorization:"Bearer ".concat(localStorage.getItem("token"))}};return(0,e.jsxs)("div",{className:"fixed right-2 top-16 flex gap-2",children:[!D&&(0,e.jsxs)("div",{className:"flex gap-2",children:[(0,e.jsx)(je.ZP,{type:"primary",onClick:ce,children:T.formatMessage({id:"workflow.release"})}),(0,e.jsx)(je.ZP,{icon:(0,e.jsx)(Wt.Z,{}),onClick:n,children:T.formatMessage({id:"workflow.run"})}),(0,e.jsx)(je.ZP,{icon:(0,e.jsx)(At.Z,{}),type:"dashed",onClick:l,children:T.formatMessage({id:"workflow.save"})})]}),(0,e.jsx)(je.ZP,{icon:(0,e.jsx)(Ft.Z,{}),type:"dashed",onClick:ee,children:T.formatMessage({id:"workflow.export",defaultMessage:""})}),de]})}),Bt=function(){var f,i,S=(0,V.useIntl)(),U=(0,d.useRef)(null),g=(0,s.Z)(function(a){return a.resetNodes}),E=(0,s.Z)(function(a){return a.setNodeTypes}),D=(0,s.Z)(function(a){return a.addNode}),l=(0,s.Z)(function(a){return a.setAgentData}),N=(0,s.Z)(function(a){return a.createNode}),q=(0,s.Z)(function(a){return a.setNodes}),J=(0,s.Z)(function(a){return a.setEdges}),de=(0,s.Z)(function(a){return a.setAppId}),ce=(0,s.Z)(function(a){return a.setSkillData}),n=(0,s.Z)(function(a){return a.setToolData}),ne=(0,s.Z)(function(a){return a.setRunPanelShow}),ee=(0,s.Z)(function(a){return a.runPanelShow}),fe=(0,s.Z)(function(a){return a.setDatasetData}),p=(0,s.Z)(function(a){return a.setTeamDatasetData}),k=(0,s.Z)(function(a){return a.getModelData}),o=(0,s.Z)(function(a){return a.setWorkFlowInfo}),h=(0,s.Z)(function(a){return a.setViewPort}),P=(0,s.Z)(function(a){return a.setHandleList}),m=(0,s.Z)(function(a){return a.workFlowInfo}),ae=(0,s.Z)(function(a){return a.setWorkflowEditInfo}),v=Oe.ZP.useMessage(),x=w()(v,2),j=x[0],R=x[1],_=(0,Q._K)(),We=_.screenToFlowPosition,ve=_.getNodes,dt=_.setViewport,Ze=Mt(We),Ve=Ze.onDnD,et=(0,V.useSearchParams)(),tt=w()(et,1),Ie=tt[0],Ae=Ie.get("type")=="true",Ue=(0,Q.B)({includeHiddenNodes:!1}),$e=(0,Me.Z)(),nt=(0,d.useState)(null),r=w()(nt,2),u=r[0],c=r[1],M=(0,Z.Z)(),C=(0,d.useState)(null),A=w()(C,2),oe=A[0],$=A[1],we=(0,d.useState)(!1),re=w()(we,2),Fe=re[0],F=re[1],K=(0,d.useState)(""),b=w()(K,2),G=b[0],ke=b[1],B=null;(0,Q.CV)({onEnd:function(H){}}),(0,rt.Z)(function(){E((0,Nt.$P)()),g(),(0,Be.b6)(),se(),P([])}),(0,d.useEffect)(function(){if(oe){V.history.push(G);return}var a=V.history.block(function(H,Se){if(ee){ke(H.location.pathname),F(!0);return}});return ee||a==null||a(),function(){a==null||a()}},[ee,oe]),(0,ye.Z)(function(){if(Ue){var a=ve(),H=a[a.length-1];H.data.drag&&(H.position={x:H.position.x-H.measured.width/2,y:H.position.y-H.measured.height/2},q(a))}},[Ue]),(0,d.useEffect)(function(){var a=Ve(function(H,Se,Le){console.log(H,Se,Le),N(Se,{position:H,data:{title:Le.name,desc:Le.description,drag:!0,baseData:Le}})});return a},[Ve,D]),(0,ye.Z)(function(){$e=="hidden"&&M()},[$e]);var se=function(){var a=W()(X()().mark(function H(){var Se;return X()().wrap(function(at){for(;;)switch(at.prev=at.next){case 0:Se=Ie.get("app_id"),Ae&&j.open({type:"warning",content:S.formatMessage({id:"workflow.nodeRunOtherMessage"}),duration:10}),de(Se),(0,O.kE)(Se,Ae?1:0).then(function(y){if(y.code==0){if(o(I()(I()({},y.data),{},{isProd:Ae})),!y.data.workflow.graph){N(ue.vW.Start);return}var pe=y.data,ot=pe.workflow.graph,zt=ot.edges,Jt=ot.nodes,le=ot.views,ct=pe.app;ae({enable_api:!!ct.enable_api,is_public:!!ct.is_public}),le!=null&&le.nodes&&q(le.nodes),le!=null&&le.edges&&J(le.edges),le!=null&&le.viewPort}}),(0,O.x$)(2).then(function(y){y.code==0&&l({team:y.data})}),(0,O.x$)(3).then(function(y){y.code==0&&l({user:y.data})}),(0,O.w)(2).then(function(y){y.code==0&&ce({team:y.data})}),(0,O.w)(3).then(function(y){y.code==0&&ce({user:y.data})}),(0,O.GZ)().then(function(y){y.code==0&&n({list:Object.values(y.data)})}),k(),(0,O.mG)().then(function(y){y.code==0&&fe({list:y.data.data.map(function(pe){return I()(I()({},pe),{},{label:pe.name,value:pe.dataset_id})})})}),(0,O.mG)(2).then(function(y){y.code==0&&p({list:y.data.data.map(function(pe){return I()(I()({},pe),{},{label:pe.name,value:pe.dataset_id})})})});case 12:case"end":return at.stop()}},H)}));return function(){return a.apply(this,arguments)}}(),Y=function(){ne(!0)},L=function(){$(!0),console.log(G),V.history.push(G),F(!1)},me=function(){F(!1)};return(0,e.jsxs)("div",{className:"dndflow",children:[R,(0,e.jsx)(mt.Z,{title:S.formatMessage({id:"workflow.modal.title",defaultMessage:""}),open:Fe,onOk:L,onCancel:me,children:S.formatMessage({id:"workflow.modal.content",defaultMessage:"\uFF0C?"})}),(0,e.jsx)("div",{className:"reactflow-wrapper",ref:U,children:(0,e.jsxs)(xt,{children:[(0,e.jsx)(Q.Aq,{}),(0,e.jsx)("div",{children:(0,e.jsx)(Q.a9,{className:"table",nodeColor:"#1890ff",position:"bottom-left",maskStrokeWidth:3,pannable:!0,nodeStrokeWidth:3})})]})}),(0,e.jsxs)("div",{className:"fixed left-8 top-16 flex  flex-col gap-2 pt-3 pl-4",children:[(0,e.jsx)(ie.Z.Title,{className:"!m-0",level:5,children:m==null||(f=m.app)===null||f===void 0?void 0:f.name}),Ae&&(0,e.jsxs)(ie.Z.Text,{children:["( ",S.formatMessage({id:"workflow.nodeRunOtherMessage"}),")"]}),(0,e.jsx)(ie.Z.Text,{children:m==null||(i=m.app)===null||i===void 0?void 0:i.description})]}),(0,e.jsx)(_t,{}),(0,e.jsx)(ut.s_,{}),(0,e.jsx)(ut.Jf,{}),(0,e.jsx)(Ot,{})]})},Ht=(0,d.memo)(function(){return(0,e.jsx)(Q.tV,{children:(0,e.jsx)(Bt,{})})}),Vt=function(){return(0,e.jsxs)("div",{style:{height:"calc(100vh - 56px)"},className:"w-full relative overflow-x-auto",children:[(0,e.jsx)(Ee,{}),(0,e.jsx)(Ht,{})]})},Ut=Vt}}]);
