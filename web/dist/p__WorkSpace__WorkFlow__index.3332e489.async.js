"use strict";(self.webpackChunkant_design_pro=self.webpackChunkant_design_pro||[]).push([[142],{26784:function(Gt,Re,n){n.r(Re),n.d(Re,{default:function(){return Jt}});var Ve=n(15009),re=n.n(Ve),Ue=n(99289),De=n.n(Ue),Ke=n(97857),P=n.n(Ke),Je=n(5574),Z=n.n(Je),Ge=n(32060),L=n(42237),X=n(35312),he=n(63648),Yt=n(16091),Ye=n(13118),Oe=n(78234),Me=n(77598),be=n(2453),Xe=n(17788),le=n(71471),c=n(67294),Qe=n(64599),qe=n.n(Qe),We=n(7493),_e=n(34559),p=n(1096),C=n(96906),e=n(85893),Xt=function(a){return{nodes:a.nodes,edges:a.edges,onNodesChange:a.onNodesChange,onEdgesChange:a.onEdgesChange,onConnect:a.onConnect,nodeTypes:a.nodeTypes,connectionLineStyle:a.connectionLineStyle,defaultViewport:a.defaultViewport,onDrop:a.onDrop,onDragOver:a.onDragOver,setSelect:a.setSelect,preventScrolling:a.preventScrolling}},et=(0,c.memo)(function(g){var a=g.children,o=(0,X.useIntl)(),d=(0,p.Z)(function(r){return r.nodes}),h=(0,p.Z)(function(r){return r.getEdges}),u=(0,p.Z)(function(r){return r.edges}),l=(0,p.Z)(function(r){return r.setEdges}),f=(0,p.Z)(function(r){return r.onNodesChange}),W=(0,p.Z)(function(r){return r.onEdgesChange}),M=(0,p.Z)(function(r){return r.onConnect}),K=(0,p.Z)(function(r){return r.nodeTypes}),F=(0,p.Z)(function(r){return r.connectionLineStyle}),q=(0,p.Z)(function(r){return r.defaultViewport}),G=(0,p.Z)(function(r){return r.onDrop}),t=(0,p.Z)(function(r){return r.onDragOver}),A=(0,p.Z)(function(r){return r.setSelect}),_=(0,p.Z)(function(r){return r.preventScrolling}),E=(0,c.useCallback)(function(r){var S=d.find(function(y){return y.id===r.target}),T=function y(oe){var I=arguments.length>1&&arguments[1]!==void 0?arguments[1]:new Set;if(I.has(oe.id))return!1;I.add(oe.id);var ee=qe()((0,We.xA)(oe,d,u)),te;try{for(ee.s();!(te=ee.n()).done;){var Q=te.value;if(Q.id===r.source||y(Q,I))return!0}}catch(B){ee.e(B)}finally{ee.f()}};return S.id===r.source?!1:!T(S)},[d,u]),x=function(){},R=(0,c.useCallback)(function(r,S){console.log(r,S,h(),(0,We.Kz)(r,S,u)),l((0,We.Kz)(r,S,h()))},[]);return(0,Me.Z)(function(){},[d]),(0,e.jsx)(_e.tV,{children:(0,e.jsx)(he.x$,{onViewportChange:x,nodes:d,edges:u,onNodesChange:f,onEdgesChange:W,onEdgesDelete:function(S){},onConnect:M,onReconnect:R,nodeTypes:K,minZoom:.3,maxZoom:1,connectionLineStyle:F,snapToGrid:!1,isValidConnection:E,connectionRadius:30,preventScrolling:_,onDragOver:t,onPaneClick:function(){A("")},onPaneContextMenu:function(S){S.preventDefault()},onSelectionChange:function(S){},onNodeClick:function(S,T){A(T.id)},onEdgeClick:function(S,T){},deleteKeyCode:["Delete","Backspace"],onNodesDelete:function(S){},onBeforeDelete:function(){var r=De()(re()().mark(function S(T){var y;return re()().wrap(function(I){for(;;)switch(I.prev=I.next){case 0:if((T==null||(y=T.nodes)===null||y===void 0||(y=y[0])===null||y===void 0?void 0:y.type)!=C.vW.Start){I.next=3;break}return be.ZP.error(o.formatMessage({id:"workflow.delStartNodeError"})),I.abrupt("return",Promise.reject(o.formatMessage({id:"workflow.delStartNodeError"})));case 3:return A(""),I.abrupt("return",Promise.resolve(T));case 5:case"end":return I.stop()}},S)}));return function(S){return r.apply(this,arguments)}}(),fitView:!0,children:a})})}),tt=function(a){var o=(0,c.useCallback)(function(u){u.preventDefault(),u.dataTransfer.dropEffect="move"},[]),d=(0,c.useCallback)(function(u){u.preventDefault();var l=u.dataTransfer.getData("application/reactflow");if(!l)return null;var f=JSON.parse(l),W=f.type,M=f.item;if(!W||!M)return null;var K=a({x:u.clientX,y:u.clientY});return{position:K,type:W,item:M}},[a]),h=(0,c.useCallback)(function(u){var l=function(W){var M=d(W);M&&u(M.position,M.type,M.item)};return document.addEventListener("dragover",o),document.addEventListener("drop",l),function(){document.removeEventListener("dragover",o),document.removeEventListener("drop",l)}},[o,d]);return{onDnD:h}},at=tt,nt=function(){var a=(0,p.Z)(function(l){return l.setAgentData}),o=(0,p.Z)(function(l){return l.setSkillData}),d=(0,p.Z)(function(l){return l.setToolData}),h=(0,p.Z)(function(l){return l.setDatasetData}),u=(0,p.Z)(function(l){return l.setTeamDatasetData});(0,c.useEffect)(function(){(0,L.x$)(2).then(function(l){l.code===0&&a({team:l.data})}),(0,L.x$)(3).then(function(l){l.code===0&&a({user:l.data})}),(0,L.w)(2).then(function(l){l.code===0&&o({team:l.data})}),(0,L.w)(3).then(function(l){l.code===0&&o({user:l.data})}),(0,L.GZ)().then(function(l){l.code===0&&d({list:Object.values(l.data)})}),(0,L.mG)().then(function(l){l.code==0&&h({list:l.data.data.map(function(f){return P()(P()({},f),{},{label:f.name,value:f.dataset_id})})})}),(0,L.mG)(2).then(function(l){l.code==0&&u({list:l.data.data.map(function(f){return P()(P()({},f),{},{label:f.name,value:f.dataset_id})})})})},[a,o,d])},ot=nt,rt=n(9783),Ne=n.n(rt),lt=n(40110),Pe=n(34994),st=n(86615),it=n(5966),ut=n(96638),dt=n(11941),ct=n(42881),vt=function(a){var o=a.children,d=a.className,h=d===void 0?"":d,u=a.dragDirection,l=u===void 0?"left":u,f=a.minWidth,W=f===void 0?415:f,M=a.maxWidth,K=M===void 0?820:M,F=a.defaultWidth,q=F===void 0?415:F,G=(0,c.useState)(q),t=Z()(G,2),A=t[0],_=t[1],E=(0,c.useCallback)(function(S){_(S)},[_]),x=(0,ct.W)({direction:"horizontal",minWidth:W,maxWidth:K,onResize:E}),R=x.triggerRef,r=x.containerRef;return(0,e.jsxs)("div",{ref:r,style:{width:"".concat(A,"px")},className:"flex flex-col p-4 shadow-lg rounded-md border border-blue-300 bg-white z-10 wrapPanel ".concat(h),children:[l==="left"&&(0,e.jsx)("div",{ref:R,className:"absolute top-1/2 -translate-y-1/2 -left-2 w-3 h-6 cursor-col-resize resize-x",children:(0,e.jsx)("div",{className:"w-1 h-6 bg-gray-300 rounded-sm"})}),l==="right"&&(0,e.jsx)("div",{ref:R,className:"absolute top-1/2 -translate-y-1/2 -right-2 flex justify-end w-3 h-6 cursor-col-resize resize-x",children:(0,e.jsx)("div",{className:"w-1 h-6 bg-gray-300 rounded-sm"})}),o]})},ft=(0,c.memo)(vt),$e=n(83062),gt=n(63783),Te=n(99510),Fe=n(41418),Qt=null,mt=(0,c.memo)(function(g){var a,o=g.item,d=g.onDragStart;return(0,e.jsx)("div",{draggable:!0,onDragStart:function(u){return d(u,o.type,o)},className:"cursor-pointer hover:bg-blue-100 rounded-md px-2 box-border",children:(0,e.jsx)(Te.Z,{title:o.data.title,icon:(o==null||(a=o.baseData)===null||a===void 0?void 0:a.icon)||o.type})})}),pt=(0,c.memo)(function(g){var a=g.item,o=g.onDragStart;return(0,e.jsx)("div",{draggable:!0,onDragStart:function(h){return o(h,a.type,a)},className:"cursor-pointer hover:bg-blue-100 rounded-md px-2 box-border",children:(0,e.jsx)(Te.Z,{title:a.baseData.name,desc:a.baseData.description,icon:a.baseData.icon||"workflow",extra:(0,e.jsx)("div",{className:"text-xs text-gray-500",children:a.baseData.nickname})})})}),ht=(0,c.memo)(function(g){var a,o,d,h=g.tool,u=g.category,l=g.onDragStart,f=(0,X.getLocale)()==="en-US"?"en_US":"zh_Hans";return(0,e.jsx)($e.Z,{placement:"right",title:h==null||(a=h.description)===null||a===void 0||(a=a.human)===null||a===void 0?void 0:a[f],children:(0,e.jsx)("div",{draggable:!0,onDragStart:function(M){return l(M,u.type,u)},className:"cursor-pointer hover:bg-blue-100 rounded-md px-2 box-border",children:(0,e.jsx)(Te.Z,{title:h==null||(o=h.identity)===null||o===void 0?void 0:o.label[f],icon:u==null||(d=u.identity)===null||d===void 0?void 0:d.icon})})})}),xt=(0,c.memo)(function(g){var a,o,d=g.category,h=g.onDragStart,u=(0,X.getLocale)()==="en-US"?"en_US":"zh_Hans";return(0,e.jsxs)("div",{children:[(0,e.jsxs)("div",{className:"text-[#333333] mb-2",children:[d==null||(a=d.identity)===null||a===void 0?void 0:a.label[u],(0,e.jsx)($e.Z,{placement:"right",title:d==null||(o=d.identity)===null||o===void 0?void 0:o.description[u],children:(0,e.jsx)(gt.Z,{className:"cursor-pointer ml-1"})})]}),d.tools.map(function(l,f){return(0,e.jsx)(ht,{tool:l,category:d,onDragStart:h},f)})]})}),yt=(0,c.memo)(function(g){var a=g.list,o=g.onDragStart;return(0,e.jsx)(e.Fragment,{children:a.map(function(d,h){return(0,e.jsx)(xt,{category:d,onDragStart:o},h)})})}),wt=function(a){var o=a.list,d=a.onDragStart,h=a.type,u=h===void 0?"normal":h;return o!=null&&o.length?(0,e.jsx)("div",{className:"grid grid-cols-[repeat(auto-fill,minmax(200px,1fr))] gap-y-2 gap-2",children:u==="tools"?(0,e.jsx)(yt,{list:o,onDragStart:d}):u==="workflow"?o.map(function(l,f){return(0,e.jsx)(pt,{item:l,onDragStart:d},f)}):o.map(function(l,f){return(0,e.jsx)(mt,{item:l,onDragStart:d},f)})}):null},St=(0,c.memo)(wt),Dt=n(54543),bt=(0,c.memo)(function(g){var a=g.visibleTabs,o=g.defaultActiveTab,d=g.showTeamSwitch,h=d===void 0?!0:d,u=(0,X.useIntl)(),l=(0,X.getLocale)()=="en-US"?"en_US":"zh_Hans",f=(0,Fe.o6)(),W=Object.values(f).filter(function(w){return![C.vW.Start,C.vW.Agent,C.vW.Tool,C.vW.Skill].includes(w.base.type)}).map(function(w){return w.base}),M=(0,c.useState)(o),K=Z()(M,2),F=K[0],q=K[1],G=(0,c.useState)(W),t=Z()(G,2),A=t[0],_=t[1],E=(0,c.useState)([]),x=Z()(E,2),R=x[0],r=x[1],S=(0,ut.Z)(Ne()(Ne()(Ne()({},C.vW.Agent,[]),C.vW.Skill,[]),"workflow",[])),T=Z()(S,2),y=T[0],oe=T[1],I=(0,c.useState)({team:1,keyword:""}),ee=Z()(I,2),te=ee[0],Q=ee[1],B=(0,p.Z)(function(w){return w.toolData});(0,c.useEffect)(function(){r((B==null?void 0:B.list)||[])},[B]);var Se=(0,c.useCallback)(function(w,O,N){w.dataTransfer.setData("application/reactflow",JSON.stringify({type:O,item:N})),w.dataTransfer.effectAllowed="move"},[]),se=(0,c.useMemo)(function(){var w=[{key:"1",tabKey:"node",label:"workflow.node",defaultMessage:"Node",type:"normal",getData:function(){return A}},{key:"2",tabKey:"agent",label:"workflow.agent",defaultMessage:"Agent",type:"normal",getData:function(){return y[C.vW.Agent]}},{key:"3",tabKey:"tool",label:"workflow.tool",defaultMessage:"Tool",type:"tools",getData:function(){return R}},{key:"4",tabKey:"skill",label:"workflow.skill",defaultMessage:"Skill",type:"normal",getData:function(){return y[C.vW.Skill]}},{key:"5",tabKey:"workflow",label:"workflow.list",defaultMessage:"Workflow",type:"workflow",getData:function(){return y.workflow}}],O=w.map(function(N){return P()(P()({},N),{},{show:!a||a.includes(N.tabKey)})});return o||q(O.filter(function(N){return N.show})[0].key),O},[A,y,R,a]),fe=(0,c.useMemo)(function(){return se.filter(function(w){return w.show}).map(function(w){return{key:w.key,label:u.formatMessage({id:w.label,defaultMessage:w.defaultMessage})}})},[se,u]),de=(0,c.useCallback)(function(){var w=se.find(function(O){return O.key===F});return w!=null&&w.show?(0,e.jsx)("div",{className:"overflow-y-auto",children:(0,e.jsx)(St,{list:w.getData(),onDragStart:Se,type:w.type})}):null},[F,se,Se]),ge=(0,c.useCallback)(function(){var w=De()(re()().mark(function O(N){var ie,ae,ye;return re()().wrap(function(i){for(;;)switch(i.prev=i.next){case 0:return i.prev=0,i.next=3,getAppListByMode(N===C.vW.Agent?"agent":N===C.vW.Skill?"skill":"workflow",{search_type:N==="workflow"?2:1,apps_name:te.keyword});case 3:ae=i.sent,(ae==null?void 0:ae.code)===0&&ae!==null&&ae!==void 0&&(ie=ae.data)!==null&&ie!==void 0&&(ie=ie.list)!==null&&ie!==void 0&&ie.length&&(ye=ae.data.list.map(function(m){var D,b;return P()(P()({},(D=f[N])===null||D===void 0?void 0:D.base),{},{data:P()(P()({},(b=f[N])===null||b===void 0?void 0:b.base.data),{},{title:m.name,desc:m.description}),baseData:m})}),oe(Ne()({},N,ye))),i.next=10;break;case 7:i.prev=7,i.t0=i.catch(0),console.error("Failed to fetch ".concat(N," data:"),i.t0);case 10:case"end":return i.stop()}},O,null,[[0,7]])}));return function(O){return w.apply(this,arguments)}}(),[te]);(0,c.useEffect)(function(){ge(C.vW.Agent),ge(C.vW.Skill),ge("workflow")},[te]);var ke=(0,c.useCallback)(function(w,O){"team"in w&&Q(O)},[]);return(0,e.jsx)(ft,{dragDirection:"right",minWidth:270,className:"fixed left-0 top-16 bg-white shadow-md",children:(0,e.jsxs)("div",{className:"h-[calc(100vh-110px)] flex flex-col",children:[(0,e.jsxs)("div",{className:"px-4 py-3",children:[(0,e.jsxs)(Pe.A,{submitter:!1,initialValues:{team:1},onValuesChange:ke,children:[h&&(0,e.jsxs)("div",{className:"flex gap-2 items-center text-base mb-4",children:[u.formatMessage({id:"workflow.nodeList",defaultMessage:"\u8282\u70B9\u5217\u8868"}),(0,e.jsx)(st.Z.Group,{name:"team",fieldProps:{options:[{label:u.formatMessage({id:"workflow.team",defaultMessage:"\u56E2\u961F"}),value:0},{label:u.formatMessage({id:"workflow.mine",defaultMessage:"\u6211\u7684"}),value:1}],size:"small",optionType:"button",buttonStyle:"solid"},formItemProps:{className:"mb-0"}})]}),(0,e.jsx)(it.Z,{fieldProps:{prefix:(0,e.jsx)(lt.Z,{}),placeholder:u.formatMessage({id:"workflow.search",defaultMessage:"\u641C\u7D22\u8282\u70B9"})},name:"keyword"}),(0,e.jsx)("div",{className:"w-full",children:(0,e.jsx)(Dt.ZP,{className:"w-full",showAddButton:!1})})]}),(0,e.jsx)(dt.Z,{activeKey:F,items:fe,onChange:function(O){q(O)}})]}),(0,e.jsx)("div",{className:"flex-1 overflow-y-auto",children:(0,e.jsx)(de,{})})]})})}),jt=n(83065),kt=n(39944),Ie=n(10759),je=n(55927),Zt=n(33914),Mt=n(88284),Nt=n(28508),Ee=n(90672),Ct=n(46822),Wt=n(97462),Pt=n(64317),Tt=n(29933),It=n(3917),Rt=n(40056),Le=n(2487),xe=n(28036),Ot=n(96486),Ae=n.n(Ot),we=n(29432),Ce=n(92485),qt=le.Z.Text,_t=Rt.Z.ErrorBoundary,$t=(0,c.memo)(function(){var g,a,o=(0,X.useIntl)(),d=(0,c.useState)(!1),h=Z()(d,2),u=h[0],l=h[1],f=(0,je.Z)(function(v){return v.dealtWithData}),W=(0,je.Z)(function(v){return v.setDealtWithData}),M=(0,je.Z)(function(v){return v.setFlowMessage}),K=(0,je.Z)(function(v){return v.getNeedHumanConfirmMessage}),F=(0,je.Z)(function(v){return v.flowMessage}),q=(0,c.useState)(null),G=Z()(q,2),t=G[0],A=G[1],_=(0,c.useState)(""),E=Z()(_,2),x=E[0],R=E[1],r=(0,c.useState)(!1),S=Z()(r,2),T=S[0],y=S[1],oe=(0,c.useState)(""),I=Z()(oe,2),ee=I[0],te=I[1],Q=(0,It.Z)(L.N7,{manual:!0}),B=Q.loading,Se=Q.runAsync;(0,c.useEffect)(function(){var v;l(!!f);var i=f==null||(v=f.data)===null||v===void 0||(v=v.node_exec_data)===null||v===void 0?void 0:v.node_exec_id;return console.log(f,i),R(i),i&&se(i),function(){l(!1)}},[f]);var se=function(i){B||Se(i).then(function(m){m.data&&(A(m.data),i!=ee&&(y(!1),te(i)))})};(0,Me.Z)(function(){console.log(F,x);var v=F.find(function(i){var m;return(i==null||(m=i.data)===null||m===void 0||(m=m.node_exec_data)===null||m===void 0?void 0:m.node_exec_id)==x});console.log(v),v&&se(x)},[F.length]);var fe=function(i){y(!0),(0,L.YX)(x,{correct_prompt:new kt.N("",i.prompt,""),operation:1,outputs:(t==null?void 0:t.outputs)||null}).then(function(m){m.code==0&&(de(x),R(m.data.exec_id))})},de=function(i){var m=F.filter(function(D){var b;return!((D==null||(b=D.data)===null||b===void 0||(b=b.node_exec_data)===null||b===void 0?void 0:b.node_exec_id)==i&&(D==null?void 0:D.type)=="workflow_need_human_confirm")});M(m)},ge=function(){(0,L.YX)(x,{operation:0,outputs:(t==null?void 0:t.outputs)||null}).then(function(i){i.code==0&&(l(!1),de(x),W(null))})},ke=(0,c.useCallback)(function(){var v,i,m=f==null||(v=f.data)===null||v===void 0||(v=v.node_exec_data)===null||v===void 0?void 0:v.node_type;return(0,e.jsxs)(e.Fragment,{children:[(0,e.jsxs)("div",{className:"flex flex-col gap-2 mt-4",children:[m!=C.vW.LLM&&(0,e.jsx)("div",{className:"h-80",children:(0,e.jsx)(Ce.Z,{language:"python3",value:t==null?void 0:t.inputs,readOnly:!0,isJSONStringifyBeauty:!0,onChange:function(){},title:"input"})}),(t==null||(i=t.correct_llm_history)===null||i===void 0?void 0:i.length)>0&&(0,e.jsx)(Le.Z,{header:(0,e.jsx)(le.Z.Title,{level:5,children:o.formatMessage({id:"workflow.historyPrompt",defaultMessage:"prompt"})}),dataSource:t==null?void 0:t.correct_llm_history,renderItem:function(b){var z;return(0,e.jsx)(Le.Z.Item,{children:b==null||(z=b.correct_prompt)===null||z===void 0||(z=z.user)===null||z===void 0?void 0:z.value})}}),(0,e.jsx)("div",{className:"h-80",children:(0,e.jsx)(Ce.Z,{language:"python3",value:t==null?void 0:t.outputs,readOnly:!0,isJSONStringifyBeauty:!0,onChange:function(){},title:"output"})})]}),(0,e.jsx)(Pe.A,{submitter:{resetButtonProps:!1,submitButtonProps:{className:"w-full"},searchConfig:{submitText:o.formatMessage({id:"workflow.xz"})}},loading:T,onFinish:fe,children:(0,e.jsx)("div",{className:"flex ",children:(0,e.jsxs)("div",{className:"flex-1 pt-2 border-stone-300 border rounded-md my-2",children:[(0,e.jsxs)("div",{className:"px-2 flex justify-between cursor-default",children:[(0,e.jsx)("div",{children:(0,e.jsx)("div",{className:"text-sm text-gray-500 font-bold pb-1",children:"Prompt"})}),(0,e.jsx)("div",{})]}),(0,e.jsx)("div",{className:" pb-6 user-input-error",children:(0,e.jsx)(Ee.Z,{formItemProps:{className:"mb-0"},name:"prompt",required:!0,rules:[{required:!0,message:o.formatMessage({id:"workflow.requireInputPrompt"})}],fieldProps:{variant:"borderless",placeholder:o.formatMessage({id:"workflow.requireInputPrompt"}),autoSize:{minRows:2,maxRows:40},count:{show:function(b){var z=b.value,ce=b.count,Y=b.maxLength;return(0,e.jsx)("div",{className:"pr-2 text-blue-400",children:ce})}}}})})]})})})]})},[t]),w=(0,c.useCallback)(function(){var v,i,m,D=t==null||(v=t.node_graph)===null||v===void 0||(v=v.data)===null||v===void 0?void 0:v.input,b=D==null?void 0:D.properties,z=t==null||(i=t.node_graph)===null||i===void 0||(i=i.data)===null||i===void 0?void 0:i.requires_upload,ce=t==null||(m=t.node_graph)===null||m===void 0||(m=m.data)===null||m===void 0||(m=m.import_to_knowledge_base)===null||m===void 0?void 0:m.input;console.log("requires_upload",t,z);var Y=(0,p.Z)(function(s){return s.datasetData});if(!b)return(0,e.jsx)(e.Fragment,{children:o.formatMessage({id:"workflow.requireInputPrompt",defaultMessage:""})});var me=Object.values(b),ue=function(j){var k;console.log(j);var J=(0,Ie.vV)(D);if(me.length>0){var pe=Object.entries(j).filter(function(H){var V=Z()(H,2),ve=V[0],U=V[1];return ve.startsWith("variables.")});pe.forEach(function(H){var V=Z()(H,2),ve=V[0],U=V[1];J.properties[ve.replace("variables.","")].value=U})}var $=new Ie.V7(we.Mp,"array[number]");j.file&&j.file.forEach(function(H){var V,ve=new Ie._w(H.uid,"number",(H==null||(V=H.response)===null||V===void 0||(V=V.data)===null||V===void 0?void 0:V.file_id)||0);$.addValue(ve)}),J.addProperty(we.Mp,$),console.log(J,$);var ne=(t==null||(k=t.node_graph)===null||k===void 0||(k=k.data)===null||k===void 0?void 0:k.knowledge_base_mapping)||{input:{},output:{}};Object.entries(j).forEach(function(H){var V=Z()(H,2),ve=V[0],U=V[1];ve.startsWith("dataset.")&&(ne.input[we.Mp]||(ne.input[we.Mp]={}),ne.input[we.Mp][ve.replace("dataset.","")]=U)}),console.log(ne),(0,L.YX)(x,{operation:0,inputs:J,outputs:null,correct_prompt:null,knowledge_base_mapping:ne}).then(function(H){H.code==0&&(l(!1),W(null),de(x))})},Ze={icon:(0,e.jsx)(Zt.Z,{}),title:o.formatMessage({id:"workflow.uploadFileText",defaultMessage:"\uFF0C"}),description:o.formatMessage({id:"workflow.uploadFileDes"}),accept:".txt,.md,.pdf,.html,.xlsx,.xls,.docx,.csv",fieldProps:{listType:"picture",name:"file",multiple:!0,headers:{Authorization:"Bearer ".concat(localStorage.getItem("token"))},action:jt.M$,beforeUpload:function(j){var k=j.size/1024/1024<15;return k||be.ZP.error(o.formatMessage({id:"workflow.uploadFileErrorText"})),k}}};return(0,e.jsx)("div",{className:"mt-4",children:(0,e.jsxs)(Pe.A,{submitter:{resetButtonProps:!1,submitButtonProps:{className:"w-full"},searchConfig:{submitText:o.formatMessage({id:"workflow.checked",defaultMessage:""})}},onFinish:ue,children:[me.map(function(s){return(0,e.jsx)(Ee.Z,{label:s.display_name,name:"variables.".concat(s.name),required:s.required,rules:[{required:s.required,message:o.formatMessage({id:"workflow.toInput"})}]},s.name)}),z&&(0,e.jsx)(Ct.Z,P()({name:"file"},Ze)),(0,e.jsx)(Wt.Z,{name:["file"],children:function(j){var k=j.file;return ce&&(k==null?void 0:k.length)>0&&(k==null?void 0:k.map(function(J){return(0,e.jsx)(Pt.Z,{label:J.name,name:"dataset.".concat(J.uid),options:(Y==null?void 0:Y.list)||[],required:!0,rules:[{required:!0,message:o.formatMessage({id:"workflow.select_to_knowledge_base"})}]},J.uid)}))||null}})]})})},[t]),O=function(i){if(i.type!=="object"||!i.properties)return[i];var m=[],D=function b(z){var ce=arguments.length>1&&arguments[1]!==void 0?arguments[1]:"";Ae().forOwn(z,function(Y,me){var ue=ce?"".concat(ce,".").concat(me):me;Y.type==="object"&&Y.properties?b(Y.properties,ue):m.push(P()(P()({},Y),{},{name:ue}))})};return D(i.properties),m},N=function(i){return i.reduce(function(m,D){return m[D.name]=D.value,m},{})},ie=(0,c.useCallback)(function(){console.log(t);var v=t==null?void 0:t.inputs,i=(0,c.useRef)(null),m=(0,c.useState)([]),D=Z()(m,2),b=D[0],z=D[1],ce=(0,c.useState)({}),Y=Z()(ce,2),me=Y[0],ue=Y[1],Ze=be.ZP.useMessage(),s=Z()(Ze,2),j=s[0],k=s[1];(0,Oe.Z)(function(){t!=null&&t.outputs&&(console.log(v,O(t==null?void 0:t.outputs)),z(O(t==null?void 0:t.outputs)),ue(JSON.stringify(O(t==null?void 0:t.outputs))))});var J=function(){var $={};try{$=JSON.parse(me),console.log($,$[0]),(0,L.YX)(x,{outputs:Ae().isArray($)?$[0]:$}).then(function(ne){ne.code==0&&(j.success(o.formatMessage({id:"workflow.checkSc",defaultMessage:""})),l(!1),de(x),W(null))})}catch(ne){console.log(ne),j.error(o.formatMessage({id:"workflow.checkOutputMessageError",defaultMessage:","}))}};return(0,e.jsxs)("div",{children:[k,(0,e.jsxs)("div",{className:"flex flex-col gap-2 pt-4",children:[!we.eT.includes(t==null?void 0:t.node_type)&&(0,e.jsxs)("div",{children:[(0,e.jsx)(le.Z.Title,{level:5,children:"Inputs"}),(0,e.jsx)("div",{className:"h-80",children:(0,e.jsx)(Ce.Z,{language:"python3",value:t==null?void 0:t.inputs,readOnly:!0,isJSONStringifyBeauty:!0,onChange:function($){ue($)}})})]}),(0,e.jsxs)(le.Z.Title,{level:5,children:["Outputs(",o.formatMessage({id:"workflow.toEdit",defaultMessage:""}),")"]}),(0,e.jsx)("div",{className:"h-80",children:(0,e.jsx)(Ce.Z,{language:"python3",value:t==null?void 0:t.outputs,isJSONStringifyBeauty:!0,onChange:function($){ue($)}})}),(0,e.jsx)(xe.ZP,{type:"primary",onClick:J,className:"w-full mt-4",children:o.formatMessage({id:"workflow.checked",defaultMessage:""})})]})]})},[t]),ae=(0,c.useCallback)(function(){var v=t==null?void 0:t.node_type;return v==C.vW.Human?(0,e.jsx)(w,{}):v==C.vW.LLM||v==C.vW.Agent||v==C.vW.TaskGeneration?(0,e.jsx)(ke,{}):(0,e.jsx)(ie,{})},[t]),ye=function(){var i=t==null?void 0:t.node_type;return i==C.vW.LLM||i==C.vW.Agent||i==C.vW.TaskGeneration?(0,e.jsx)(xe.ZP,{type:"text",onClick:ge,className:"text-green-500",disabled:T,icon:(0,e.jsx)(Mt.Z,{}),children:o.formatMessage({id:"workflow.checkBackLogs",defaultMessage:""})}):null};return u?(0,e.jsx)(Tt.Z,{className:"w-[400px] border border-blue-300 fixed z-10  top-[105px] right-2 ",style:{height:"calc(100vh - 10px - 100px)"},extra:(0,e.jsxs)("div",{className:"flex gap-2",children:[(0,e.jsx)(ye,{}),(0,e.jsx)(xe.ZP,{onClick:function(){l(!1),W(null)},type:"text",icon:(0,e.jsx)(Nt.Z,{})})]}),title:(0,e.jsx)(le.Z.Title,{level:5,children:o.formatMessage({id:"workflow.backlogs",defaultMessage:""})}),bodyStyle:{overflowY:"auto",marginTop:"20px",boxSizing:"border-box"},children:(0,e.jsxs)("div",{children:[(0,e.jsx)("div",{children:(0,e.jsx)(le.Z.Title,{level:5,children:t==null||(g=t.node_graph)===null||g===void 0||(g=g.data)===null||g===void 0?void 0:g.title})}),(0,e.jsx)("div",{children:(0,e.jsx)(le.Z.Text,{children:t==null||(a=t.node_graph)===null||a===void 0||(a=a.data)===null||a===void 0?void 0:a.desc})}),ae()]})}):null}),Be=n(55877),ze=n(10899),Ft=n(47520),Et=n(74842),Lt=n(98165),At=n(58638),Bt=n(27484),zt=n.n(Bt),Ht=(0,c.memo)(function(){var g=(0,X.useIntl)(),a=(0,X.useSearchParams)(),o=Z()(a,1),d=o[0],h=(0,p.Z)(function(x){return x.setWorkFlowInfo}),u=(0,p.Z)(function(x){return x.workFlowInfo}),l=(0,p.Z)(function(x){return x.setRunPanelShow}),f=d.get("type")=="true",W=(0,ze.Z)(),M=be.ZP.useMessage(),K=Z()(M,2),F=K[0],q=K[1],G=function(){var R=d.get("app_id");(0,L.aJ)(R).then(function(r){console.log(r),r.code==0&&(h(P()(P()({},u),{},{app:P()(P()({},u==null?void 0:u.app),{},{publish_status:"1"})})),F.open({type:"success",content:g.formatMessage({id:"workflow.releaseSuc"})}))})},t=function(){l(!0)},A=function(){var x=De()(re()().mark(function R(){var r,S;return re()().wrap(function(y){for(;;)switch(y.prev=y.next){case 0:return r=d.get("app_id"),y.next=3,(0,L.Uq)(r);case 3:S=y.sent;case 4:case"end":return y.stop()}},R)}));return function(){return x.apply(this,arguments)}}(),_=function(){var x=De()(re()().mark(function R(){var r,S,T,y;return re()().wrap(function(I){for(;;)switch(I.prev=I.next){case 0:S=d.get("app_id"),T=(u==null||(r=u.app)===null||r===void 0?void 0:r.name)||"workflow",y=zt()().format("YYYY_MM_DD-HH_mm_ss"),(0,L.w8)(S,f==!0?1:0).then(function(ee){var te=new Blob([ee],{type:"text/yaml"}),Q=URL.createObjectURL(te),B=document.createElement("a");B.href=Q,B.download="".concat(T,"_").concat(y,".yml"),document.body.appendChild(B),B.click(),document.body.removeChild(B),URL.revokeObjectURL(Q)});case 4:case"end":return I.stop()}},R)}));return function(){return x.apply(this,arguments)}}(),E={name:"file",fileList:null,action:Ft._n+"/v1/workflow/import",accept:".yml",multiple:!1,headers:{Authorization:"Bearer ".concat(localStorage.getItem("token"))}};return(0,e.jsxs)("div",{className:"fixed right-2 top-16 flex gap-2",children:[!f&&(0,e.jsxs)("div",{className:"flex gap-2",children:[(0,e.jsx)(xe.ZP,{type:"primary",onClick:G,children:g.formatMessage({id:"workflow.release"})}),(0,e.jsx)(xe.ZP,{icon:(0,e.jsx)(Et.Z,{}),onClick:t,children:g.formatMessage({id:"workflow.run"})}),(0,e.jsx)(xe.ZP,{icon:(0,e.jsx)(Lt.Z,{}),type:"dashed",onClick:W,children:g.formatMessage({id:"workflow.save"})})]}),(0,e.jsx)(xe.ZP,{icon:(0,e.jsx)(At.Z,{}),type:"dashed",onClick:_,children:g.formatMessage({id:"workflow.export",defaultMessage:""})}),q]})}),Vt=function(){var a,o,d=(0,X.useIntl)(),h=(0,c.useRef)(null),u=(0,p.Z)(function(s){return s.resetNodes}),l=(0,p.Z)(function(s){return s.setNodeTypes}),f=(0,p.Z)(function(s){return s.addNode}),W=(0,p.Z)(function(s){return s.createNode}),M=(0,p.Z)(function(s){return s.setNodes}),K=(0,p.Z)(function(s){return s.setEdges}),F=(0,p.Z)(function(s){return s.setAppId}),q=(0,p.Z)(function(s){return s.setRunPanelShow}),G=(0,p.Z)(function(s){return s.runPanelShow}),t=(0,p.Z)(function(s){return s.getModelData}),A=(0,p.Z)(function(s){return s.setWorkFlowInfo}),_=(0,p.Z)(function(s){return s.setHandleList}),E=(0,p.Z)(function(s){return s.workFlowInfo}),x=(0,p.Z)(function(s){return s.setWorkflowEditInfo}),R=be.ZP.useMessage(),r=Z()(R,2),S=r[0],T=r[1],y=(0,he._K)(),oe=y.screenToFlowPosition,I=y.getNodes,ee=y.setViewport,te=at(oe),Q=te.onDnD,B=(0,X.useSearchParams)(),Se=Z()(B,1),se=Se[0],fe=se.get("type")=="true",de=(0,he.B)({includeHiddenNodes:!1}),ge=(0,Ye.Z)(),ke=(0,ze.Z)(),w=(0,c.useState)(null),O=Z()(w,2),N=O[0],ie=O[1],ae=(0,c.useState)(!1),ye=Z()(ae,2),v=ye[0],i=ye[1],m=(0,c.useState)(""),D=Z()(m,2),b=D[0],z=D[1],ce=null;(0,he.CV)({onEnd:function(j){}}),(0,Oe.Z)(function(){l((0,Fe.$P)()),u(),(0,Ge.b6)(),Y(),_([])}),ot(),(0,c.useEffect)(function(){if(N){X.history.push(b);return}var s=X.history.block(function(j,k){if(G){z(j.location.pathname),i(!0);return}});return G||s==null||s(),function(){s==null||s()}},[G,N]),(0,Me.Z)(function(){if(de){var s=I(),j=s[s.length-1];j.data.drag&&(j.position={x:j.position.x-j.measured.width/2,y:j.position.y-j.measured.height/2},M(s))}},[de]),(0,c.useEffect)(function(){var s=Q(function(j,k,J){console.log(j,k,J),W(k,{position:j,data:P()(P()({drag:!0},J.data),{},{baseData:J.baseData})})});return s},[Q,f]),(0,Me.Z)(function(){ge=="hidden"&&ke()},[ge]);var Y=function(){var s=De()(re()().mark(function j(){var k;return re()().wrap(function(pe){for(;;)switch(pe.prev=pe.next){case 0:k=se.get("app_id"),fe&&S.open({type:"warning",content:d.formatMessage({id:"workflow.nodeRunOtherMessage"}),duration:10}),F(k),(0,L.kE)(k,fe?1:0).then(function($){if($.code==0){if(A(P()(P()({},$.data),{},{isProd:fe})),!$.data.workflow.graph){W(C.vW.Start);return}var ne=$.data,H=ne.workflow.graph,V=H.edges,ve=H.nodes,U=H.views,He=ne.app;x({enable_api:!!He.enable_api,is_public:!!He.is_public}),U!=null&&U.nodes&&M(U.nodes),U!=null&&U.edges&&K(U.edges),U!=null&&U.viewPort}}),t();case 5:case"end":return pe.stop()}},j)}));return function(){return s.apply(this,arguments)}}(),me=function(){q(!0)},ue=function(){ie(!0),console.log(b),X.history.push(b),i(!1)},Ze=function(){i(!1)};return(0,e.jsxs)("div",{className:"dndflow",children:[T,(0,e.jsx)(Xe.Z,{title:d.formatMessage({id:"workflow.modal.title",defaultMessage:""}),open:v,onOk:ue,onCancel:Ze,children:d.formatMessage({id:"workflow.modal.content",defaultMessage:""})}),(0,e.jsx)("div",{className:"reactflow-wrapper",ref:h,children:(0,e.jsxs)(et,{children:[(0,e.jsx)(he.Aq,{}),(0,e.jsx)("div",{children:(0,e.jsx)(he.a9,{className:"table",nodeColor:"#1890ff",position:"bottom-left",maskStrokeWidth:3,pannable:!0,nodeStrokeWidth:3})})]})}),(0,e.jsxs)("div",{className:"fixed left-8 top-16 flex  flex-col gap-2 pt-3 pl-4",children:[(0,e.jsx)(le.Z.Title,{className:"!m-0",level:5,children:E==null||(a=E.app)===null||a===void 0?void 0:a.name}),fe&&(0,e.jsxs)(le.Z.Text,{children:["( ",d.formatMessage({id:"workflow.nodeRunOtherMessage"}),")"]}),(0,e.jsx)(le.Z.Text,{children:E==null||(o=E.app)===null||o===void 0?void 0:o.description})]}),(0,e.jsx)(bt,{visibleTabs:["agent","workflow"]}),(0,e.jsx)(Ht,{}),(0,e.jsx)(Be.s_,{}),(0,e.jsx)(Be.Jf,{}),(0,e.jsx)($t,{})]})},Ut=(0,c.memo)(function(){return(0,e.jsx)(he.tV,{children:(0,e.jsx)(Vt,{})})}),Kt=function(){return(0,e.jsx)("div",{style:{height:"calc(100vh - 56px)"},className:"w-full relative overflow-x-auto",children:(0,e.jsx)(Ut,{})})},Jt=Kt}}]);
